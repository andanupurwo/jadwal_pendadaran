name: Auto Deploy to Production

on:
  push:
    branches: [ "main" ]

# jobs:
#   deploy:
#     name: Deploy to Debian Server
#     runs-on: ubuntu-latest
    
#     steps:
#     - name: Executing remote ssh commands using key
#       uses: appleboy/ssh-action@v1.0.3
#       with:
#         host: ${{ secrets.SERVER_HOST }}
#         username: ${{ secrets.SERVER_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         #port: 22
#         script: |
#           # 1. Masuk ke folder project
#           cd /var/www/jadwal-pendadaran
          
#           # 2. Tarik update terbaru
#           echo "ğŸ“¥ Pulling latest code..."
#           git pull origin main
          
#           # 3. Update & Build Frontend
#           echo "ğŸ—ï¸ Building Frontend..."
#           cd frontend
#           npm install
#           npm run build
          
#           # 4. Update Backend
#           echo "ğŸ”„ Updating Backend..."
#           cd ../backend
#           npm install
          
#           # 5. Restart Aplikasi via PM2
#           echo "ğŸš€ Restarting PM2..."
#           pm2 restart all || pm2 start server.js --name "jadwal-backend"
          
#           echo "âœ… Deployment Success!"

jobs:
  deploy:
    name: Deploy to Debian Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # Langkah tambahan: Install cloudflared di Runner GitHub
    - name: Install Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb

    - name: Executing remote ssh commands using key
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }} # Isi dengan: ssh-penjadwalan.daak.my.id
        username: ${{ secrets.SERVER_USER }} # Isi dengan: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # Tambahkan ProxyCommand di bawah ini
        proxy_command: /usr/local/bin/cloudflared access ssh --hostname ${{ secrets.SERVER_HOST }}
        script: |
          # 1. Masuk ke folder project
          cd /var/www/jadwal-pendadaran
          
          # 2. Tarik update terbaru
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # 3. Update & Build Frontend
          echo "ğŸ—ï¸ Building Frontend..."
          cd frontend
          npm install
          npm run build
          
          # 4. Update Backend
          echo "ğŸ”„ Updating Backend..."
          cd ../backend
          npm install
          
          # 5. Restart Aplikasi via PM2
          echo "ğŸš€ Restarting PM2..."
          pm2 restart all || pm2 start server.js --name "jadwal-backend"
          
          echo "âœ… Deployment Success!"
